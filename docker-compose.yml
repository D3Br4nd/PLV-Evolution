services:
    init:
        image: alpine:latest
        command: >
            sh -c "mkdir -p /data/pgsql /data/redis &&
                   chmod -R 777 /data"
        volumes:
            - ./docker:/data
        user: root

    app:
        build:
            context: .
            dockerfile: Dockerfile
        restart: unless-stopped
        # ports:
        #     - "${APP_PORT:-8000}:8000" # enable only if you want to expose to host
        volumes:
            - '.:/app'
        env_file:
            - .env
        environment:
            SERVER_NAME: 'http://:8000'
        networks:
            - plv_network
        depends_on:
            init:
                condition: service_completed_successfully
            db:
                condition: service_healthy
            redis:
                condition: service_healthy

    db:
        image: 'postgres:18.1'
        restart: unless-stopped
        # ports:
        #     - "${DB_PORT_FORWARD:-5432}:5432" # enable only if you want to connect from host
        environment:
            POSTGRES_DB: '${DB_DATABASE:-plv_saas}'
            POSTGRES_USER: '${DB_USERNAME:-sail}'
            POSTGRES_PASSWORD: '${DB_PASSWORD:-password}'
        volumes:
            # Postgres 18+ expects a single mount at /var/lib/postgresql (it will create versioned subdirs)
            - './docker/pgsql:/var/lib/postgresql'
        networks:
            - plv_network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-sail} -d ${DB_DATABASE:-plv_saas}"]
            interval: 10s
            timeout: 5s
            retries: 5

    redis:
        image: 'redis:8.4.0'
        restart: unless-stopped
        # ports:
        #     - "${REDIS_PORT_FORWARD:-6379}:6379" # enable only if you want to connect from host
        volumes:
            - './docker/redis:/data'
        command: redis-server --appendonly yes
        networks:
            - plv_network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    reverb:
        build:
            context: .
            dockerfile: Dockerfile
        restart: unless-stopped
        command: php artisan reverb:start --host="0.0.0.0" --port=8080
        # ports:
        #     - "${REVERB_PORT_FORWARD:-8080}:8080" # enable only if you want to expose to host
        env_file:
            - .env
        environment:
            REVERB_HOST: "0.0.0.0"
            REVERB_PORT: 8080
            REVERB_SCHEME: "http"
        volumes:
            - '.:/app'
        networks:
            - plv_network
        depends_on:
            init:
                condition: service_completed_successfully
            redis:
                condition: service_healthy
    
    vite:
        image: 'node:24.12.0'
        working_dir: /app
        command: sh -c "npm install && npm run dev"
        restart: unless-stopped
        # ports:
        #     - "${VITE_PORT_FORWARD:-5173}:5173" # enable only if you want to access Vite from host
        volumes:
            - '.:/app'
        networks:
            - plv_network
        environment:
            VITE_HOST: '0.0.0.0'

networks:
    plv_network:
        driver: ${DOCKER_NETWORK_DRIVER:-bridge}
