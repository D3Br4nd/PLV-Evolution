services:
    init:
        image: alpine:latest
        container_name: plv_evo_init
        command: >
            sh -c "mkdir -p /data/pgsql /data/redis /data/storage/app/public /data/storage/framework/cache /data/storage/framework/sessions /data/storage/framework/views /data/storage/logs &&
                   chmod -R 777 /data"
        volumes:
            - ./docker:/data
        user: root
        networks:
            - plv_network

    app:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: plv_evo_app
        restart: unless-stopped
        # ports:
        #     - "${APP_PORT:-8000}:8000" # enable only if you want to expose to host
        volumes:
            # Persist Laravel storage (uploads, cache, logs)
            - './docker/storage:/app/storage'
        env_file:
            - .env
        environment:
            SERVER_NAME: 'http://:8000'
            DB_HOST: plv_evo_db
            REDIS_HOST: plv_evo_redis
        networks:
            - plv_network
        depends_on:
            init:
                condition: service_completed_successfully
            db:
                condition: service_healthy
            redis:
                condition: service_healthy

    db:
        image: 'postgres:18.1'
        container_name: plv_evo_db
        restart: unless-stopped
        # ports:
        #     - "${DB_PORT_FORWARD:-5432}:5432" # enable only if you want to connect from host
        environment:
            POSTGRES_DB: '${DB_DATABASE:-plv_evo}'
            POSTGRES_USER: '${DB_USERNAME:-sail}'
            POSTGRES_PASSWORD: '${DB_PASSWORD:-password}'
        volumes:
            - './docker/pgsql:/var/lib/postgresql'
        networks:
            - plv_network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-sail} -d ${DB_DATABASE:-plv_evo}"]
            interval: 10s
            timeout: 5s
            retries: 5

    redis:
        image: 'redis:8.4.0'
        container_name: plv_evo_redis
        restart: unless-stopped
        # ports:
        #     - "${REDIS_PORT_FORWARD:-6379}:6379" # enable only if you want to connect from host
        volumes:
            - './docker/redis:/data'
        command: redis-server --appendonly yes
        networks:
            - plv_network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    reverb:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: plv_evo_reverb
        restart: unless-stopped
        command: php artisan reverb:start --host="0.0.0.0" --port=8080
        # ports:
        #     - "${REVERB_PORT_FORWARD:-8080}:8080" # enable only if you want to expose to host
        env_file:
            - .env
        environment:
            REVERB_HOST: "0.0.0.0"
            REVERB_PORT: 8080
            REVERB_SCHEME: "http"
            REDIS_HOST: plv_evo_redis
        volumes:
            - './docker/storage:/app/storage'
        networks:
            - plv_network
        depends_on:
            init:
                condition: service_completed_successfully
            redis:
                condition: service_healthy
        healthcheck:
            # Escape "$" as "$$" to avoid Docker Compose env interpolation.
            test: ["CMD-SHELL", "php -r '$$fp=@fsockopen(\"127.0.0.1\",8080); if($$fp){fclose($$fp); exit(0);} exit(1);'"]
            interval: 10s
            timeout: 3s
            retries: 10

    worker:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: plv_evo_worker
        restart: unless-stopped
        command: php artisan queue:work --tries=3 --timeout=90
        env_file:
            - .env
        environment:
            DB_HOST: plv_evo_db
            REDIS_HOST: plv_evo_redis
        volumes:
            - './docker/storage:/app/storage'
        networks:
            - plv_network
        depends_on:
            init:
                condition: service_completed_successfully
            db:
                condition: service_healthy
            redis:
                condition: service_healthy
    
    vite:
        image: 'node:24.12.0'
        container_name: plv_evo_vite
        profiles: ["dev"]
        working_dir: /app
        command: sh -c "npm install && npm run dev"
        restart: unless-stopped
        # ports:
        #     - "${VITE_PORT_FORWARD:-5173}:5173" # enable only if you want to access Vite from host
        volumes:
            - '.:/app'
        networks:
            - plv_network
        environment:
            VITE_HOST: '0.0.0.0'
            # HMR is enabled only when VITE_HMR_HOST is set (see vite.config.js).
            VITE_HMR_HOST: ${VITE_HMR_HOST:-}
            VITE_HMR_PROTOCOL: ${VITE_HMR_PROTOCOL:-ws}
            VITE_HMR_CLIENT_PORT: ${VITE_HMR_CLIENT_PORT:-5173}

networks:
    plv_network:
        external: true
        name: plv_network
